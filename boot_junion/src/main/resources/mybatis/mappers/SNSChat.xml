<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.DAO.SNSChatDAO">
    
    <select id="selectAllRooms" resultType="com.boot.DTO.SNSRoom">
		WITH recent_messages AS (
		    SELECT t1.chat_id, 
		           t1.sender_id, 
		           t1.receiver_id, 
		           t1.chatRoom_id, 
		           t1.message, 
		           t1.timestamp
		    FROM chat_tb t1
		    JOIN (
		        SELECT chatRoom_id, MAX(chat_id) AS latest_chat_id
		        FROM chat_tb
		        GROUP BY chatRoom_id
		    ) t2
		    ON t1.chatRoom_id = t2.chatRoom_id
		    AND t1.chat_id = t2.latest_chat_id
		),
		related_users AS (
		    SELECT DISTINCT
				   chatRoom_id,
		           CASE 
		               WHEN sender_id = #{senderId} THEN receiver_id
		               ELSE sender_id
		           END AS other_id
		    FROM chatroom_tb
		    WHERE sender_id = #{senderId} OR receiver_id = #{senderId}
		)
		SELECT u.user_name,
			   u.user_email,
			   rm.chatRoom_id,
		       rm.sender_id,
		       rm.message,
		       rm.timestamp
		FROM user_tb u
		JOIN related_users ru ON u.user_email = ru.other_id
		JOIN recent_messages rm ON rm.chatRoom_id = ru.chatRoom_id
		WHERE rm.chatRoom_id IN (
		    SELECT DISTINCT chatRoom_id 
		    FROM chatroom_tb 
		    WHERE sender_id = #{senderId} OR receiver_id = #{senderId}
		);
    </select>
    
    <select id="checkRooms" resultType="int">
        SELECT count(*) 
        FROM chatRoom_tb
        WHERE (sender_id = #{senderId} AND receiver_id = #{receiverId})
   		   OR (sender_id = #{receiverId} AND receiver_id = #{senderId})
    </select>
    
    <select id="getRooms" resultType="int">
        SELECT chatRoom_id
        FROM chatRoom_tb
        WHERE (sender_id = #{senderId} AND receiver_id = #{receiverId})
   		   OR (sender_id = #{receiverId} AND receiver_id = #{senderId})
    </select>

    <insert id="insertRoom" parameterType="com.boot.DTO.SNSRoom">
        INSERT INTO chatRoom_tb (sender_id, receiver_id) VALUES (#{senderId}, #{receiverId})
    </insert>
    

    <select id="selectMessagesByRoomId" parameterType="int" resultType="com.boot.DTO.SNSChat">
        SELECT * FROM chat_tb WHERE chatRoom_id = #{roomId} ORDER BY timestamp
    </select>

    <insert id="insertMessage" parameterType="com.boot.DTO.SNSChat">
        INSERT INTO chat_tb (sender_id, receiver_id, chatRoom_id, message, timestamp)
        VALUES (#{sender_id}, #{receiver_id}, #{chatRoom_id}, #{message}, #{timestamp})
    </insert>
    
</mapper>










